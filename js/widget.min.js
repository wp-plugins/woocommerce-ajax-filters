/* http://dean.edwards.name/packer/ */
(function ($){
    $(document).ready(function (){

        var berocket_aapf_widget_product_filters = JSON.parse(the_ajax_script.berocket_aapf_widget_product_filters),
            berocket_aapf_widget_product_limits = [],
            berocket_aapf_widget_product_price_limit = [],
            woocommerce_pagination_page = 1;

        if( $('.woocommerce-pagination').hasClass('.woocommerce-pagination') ){
            woocommerce_pagination_page = parseInt( $('.woocommerce-pagination .current').text() );
            if( woocommerce_pagination_page < 1 ) woocommerce_pagination_page = 1;
        }

        function updateProducts( $el ){
            if ( typeof the_ajax_script.user_func != 'undefined'
                && the_ajax_script.user_func != null
                && typeof the_ajax_script.user_func.before_update != 'undefined'
                && the_ajax_script.user_func.before_update.length > 0
            ) {
                eval( the_ajax_script.user_func.before_update );
            }

            $(the_ajax_script.products_holder_id).addClass('hide_products').append('<div class="berocket_aapf_widget_loading" />');

            if( $el ){
                if( $el.is("select") ) el_data = $el.find("option:selected").data();
                else el_data = $el.data();

                if( $el.is("select") ){
                    $(berocket_aapf_widget_product_filters).each(function (i, o) {
                        if (o[0] == el_data.taxonomy) {
                            berocket_aapf_widget_product_filters.splice(i, 1);
                        }
                    });
                    if( $el.val() )
                        berocket_aapf_widget_product_filters[berocket_aapf_widget_product_filters.length] = [el_data.taxonomy, el_data.term_id, el_data.operator];
                }else {
                    if ($el.is(':checked') || $el.is(':selected')) {
                        berocket_aapf_widget_product_filters[berocket_aapf_widget_product_filters.length] = [el_data.taxonomy, el_data.term_id, el_data.operator];
                    } else {
                        $(berocket_aapf_widget_product_filters).each(function (i, o) {
                            if (o[0] == el_data.taxonomy && o[1] == el_data.term_id) {
                                berocket_aapf_widget_product_filters.splice(i, 1);
                            }
                        });
                    }
                }
            }

            berocket_aapf_widget_product_limits = [];
            berocket_aapf_widget_product_price_limit = [];

            $t = $('.berocket_filter_slider');
            if( $t.hasClass('berocket_filter_slider') ){
                $t.each(function (i,o){
                    val1 = $('#'+$(o).data('fields_1')).val();
                    val2 = $('#'+$(o).data('fields_2')).val();
                    if( val1 != $(o).data('min') || val2 != $(o).data('max') ){
                        if( $(o).hasClass('berocket_filter_price_slider') ){
                            berocket_aapf_widget_product_price_limit = [val1, val2];
                        }else{
                            berocket_aapf_widget_product_limits[berocket_aapf_widget_product_limits.length] = [$(o).data('taxonomy'), val1, val2];
                        }
                    }
                });
            }

            if( $('.woocommerce-pagination').hasClass( '.woocommerce-pagination' ) ){
                $('.woocommerce-pagination ul.page-numbers li a');
            }

            args = {
                terms: berocket_aapf_widget_product_filters,
                price: berocket_aapf_widget_product_price_limit,
                limits: berocket_aapf_widget_product_limits,
                product_cat: the_ajax_script.product_cat,
                action: 'berocket_aapf_listener',
                orderby: $('.woocommerce-ordering select.orderby').val()
            };

            if( the_ajax_script.seo_friendly_urls && 'history' in window && 'pushState' in history ) {
                updateLocation(args);
                args.location = location.href;
            }else{
                args.location = the_ajax_script.current_page_url;

                cur_page = $('.woocommerce-pagination span.current').text();
                if( prev_page = location.href.replace(/.+\/page\/([0-9]+).+/, "$1") ){
                    if( ! parseInt( cur_page ) ){
                        cur_page = prev_page;
                    }
                    args.location = args.location.replace(/\/?/,"") + "/page/" + cur_page + "/";
                }else if( prev_page = location.href.replace(/.+paged?=([0-9]+).+/, "$1") ){
                    if( ! parseInt( cur_page ) ){
                        cur_page = prev_page;
                    }
                    args.location = args.location.replace(/\/?/,"") + "/?page=" + cur_page + "";
                }
            }

            $.post(the_ajax_script.ajaxurl, args, function (data) {
                $('.woocommerce-result-count').remove();
                $('.woocommerce-pagination').remove();
                $('form.woocommerce-ordering').remove();

                if ( typeof the_ajax_script.user_func != 'undefined'
                    && the_ajax_script.user_func != null
                    && typeof the_ajax_script.user_func.on_update != 'undefined'
                    && the_ajax_script.user_func.on_update.length > 0
                ) {
                    eval( the_ajax_script.user_func.on_update );
                }

                if ( $('.woocommerce-info').hasClass('woocommerce-info') && ! $(the_ajax_script.products_holder_id).is(':visible') ) {
                    if ( typeof data.products != 'undefined' ) {
                        $('.woocommerce-info').replaceWith(data.products);
                    }
                } else {
                    if ( typeof data.no_products != 'undefined' ) {
                        $(the_ajax_script.products_holder_id).html(data.no_products).removeClass('hide_products');
                    } else {
                        $(the_ajax_script.products_holder_id).replaceWith(data.products).removeClass('hide_products');
                    }
                }

                $('.berocket_aapf_widget_loading').remove();

                aapf_action_init();

                if ( typeof the_ajax_script.user_func != 'undefined'
                    && the_ajax_script.user_func != null
                    && typeof the_ajax_script.user_func.after_update != 'undefined'
                    && the_ajax_script.user_func.after_update.length > 0
                ) {
                    eval( the_ajax_script.user_func.after_update );
                }
            }, "json");
        }

        function updateLocation( args ){
            uri_request_array = [];
            uri_request = '';

            if( args.orderby && $('.woocommerce-ordering select.orderby option:first').attr('value') != args.orderby ){
                uri_request_array[uri_request_array.length] = 'order='+args.orderby;
            }
            if( args.product_cat && args.product_cat > 0 ){
                uri_request_array[uri_request_array.length] = 'pcategory='+args.product_cat;
            }
            if( args.price ){
                $price_obj = $('.berocket_filter_price_slider');
                if( args.price[0] && args.price[1] && ( args.price[0] != $price_obj.data('min') || args.price[1] != $price_obj.data('max') ) ){
                    uri_request_array[uri_request_array.length] = 'price='+args.price[0]+'^'+args.price[1];
                }
            }
            if( args.limits ){
                $( args.limits).each(function (i,o){
                    uri_request_array[uri_request_array.length] = o[0].substring(3)+'='+o[1]+'^'+o[2];
                });
            }
            if( args.terms ){
                $( args.terms).each(function (i,o){
                    uri_request_array[uri_request_array.length] = o[0].substring(3)+'='+o[1]+'^'+o[2];
                });
            }

            var uri = the_ajax_script.current_page_url;

            if( uri_request_array.length ){
                $(uri_request_array).each(function (i,o){
                    if( uri_request ) uri_request += "|";
                    uri_request += o;
                });
            }

            cur_page = $('.woocommerce-pagination span.current').text();
            if( prev_page = parseInt( location.href.replace(/.+\/page\/([0-9]+).+/, "$1") ) ){
                if( ! parseInt( cur_page ) ){
                    cur_page = prev_page;
                }
                uri = uri.replace(/\/?$/,"") + "/page/" + cur_page + "/";
                if( uri_request ){
                    uri = uri + "/?filters=" + uri_request;
                }
            }else{
                something_added = false;
                if( /\?/.test(location.href) ){
                    passed_vars1 = location.href.split('?');
                    if( passed_vars1[1] ){
                        passed_vars2 = [];
                        temp2 = [];
                        if( /&/.test(passed_vars1[1]) ) {
                            passed_vars2 = passed_vars1[1].split('&');
                            passed_vars2_length = passed_vars2.length;
                            for ( k = 0; k < passed_vars2_length; k++ ){
                                temp = passed_vars2[k].split('=');
                                passed_vars2[k] = [];
                                passed_vars2[k][0] = temp.shift();
                                passed_vars2[k][1] = temp.join("=")
                            }
                        }else{
                            passed_vars2[0] = [];
                            temp = passed_vars1[1].split('=');
                            passed_vars2[0][0] = temp.shift();
                            passed_vars2[0][1] = temp.join("=")
                        }
                        for ( k = 0; k < passed_vars2.length; k++ ){
                            if( passed_vars2[k][0] == 'filters' || passed_vars2[k][0] == 'page'  || passed_vars2[k][0] == 'paged' ) continue;

                            if( something_added ) uri += '&';
                            else                  uri += '?';

                            uri += passed_vars2[k][0]+'='+passed_vars2[k][1];
                            something_added = true;
                        }
                    }
                }
                if( something_added && uri_request ){
                    uri = uri + "&filters=" + uri_request;
                    if( cur_page > 1 ){
                        uri = uri + "&paged=" + parseInt( cur_page );
                    }
                }else if( uri_request ){
                    uri = uri + "/?filters=" + uri_request;
                    if( cur_page > 1 ){
                        uri = uri + "&paged=" + parseInt( cur_page );
                    }
                }else if( cur_page > 1 ){
                    uri = uri + "/?paged=" + parseInt( cur_page );
                }
            }

            var stateParameters = { BeRocket: "Rules" };
            history.pushState(stateParameters, "BeRocket Rules", uri);
            history.pathname = uri;
        }

        function aapf_action_init(){
            // Take control over (default) pagination and sorting, make it AJAXy and work with filters
            $('.woocommerce-pagination').on('click', 'a', function (event) {
                event.preventDefault();
                if ( $(this).hasClass('next') ) {
                    _next_page = parseInt( $('.woocommerce-pagination span.current').text() ) + 1;
                } else if ( $(this).hasClass('prev') ) {
                    _next_page = parseInt( $('.woocommerce-pagination span.current').text() ) - 1;
                } else {
                    _next_page = $(this).text();
                }
                $('.woocommerce-pagination span.current').removeClass('current');
                $(this).after("<span class='page-numbers current'>"+_next_page+"</span>").remove();
                updateProducts(false);
            });
        }

        $('.berocket_aapf_widget').on("change", "input, select", function(){
            updateProducts( $(this) );
        });

        $( ".berocket_filter_slider" ).each(function (i,o){
            $(o).slider({
                range: true,
                min: $(o).data('min')>>0,
                max: $(o).data('max')>>0,
                values: [$(o).data('value1')>>0,$(o).data('value2')>>0],
                slide: function( event, ui ) {
                    $o = $(ui.handle).parents('div.berocket_filter_slider');
                    vals = ui.values;
                    if( $(o).hasClass('berocket_filter_price_slider') ){
                        vals[0] = vals[0].toFixed(2);
                        vals[1] = vals[1].toFixed(2);
                    }
                    $( '#'+$o.data('fields_1') ).val( vals[0] );
                    $( '#'+$o.data('fields_2') ).val( vals[1] );
                },
                stop: function(){
                    updateProducts( false );
                }
            });
        });

        $(".berocket_aapf_widget_height_control").each(function (i,o){
            $(o).mCustomScrollbar({
                axis: "xy",
                theme: $(o).data('scroll_theme'),
                scrollInertia: 300
            });
        });

        // Option to take control over (default) sorting, make it AJAXy and work with filters
        if( the_ajax_script.control_sorting ) {
            $(document).on('submit', 'form.woocommerce-ordering', function (event) {
                event.preventDefault();
            });
            $(document).on('change', 'select.orderby', function (event) {
                event.preventDefault();
                updateProducts(false);
            });
        }

        aapf_action_init();

    });
})(jQuery);
